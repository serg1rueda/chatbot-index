<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chatbot Interactivo</title>
<style>
body { font-family: Arial, sans-serif; background:#f4f9f4; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
#chat-container { width:420px; height:620px; border:1px solid #ccc; border-radius:15px; background:#fff; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 0 15px rgba(0,0,0,0.2); }
#messages { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; }
.message { margin:8px 0; padding:10px 15px; border-radius:20px; max-width:75%; word-wrap:break-word; opacity:0; animation:fadeIn 0.3s forwards; }
body { font-family: Arial, sans-serif; background:#f4f9f4; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
#chat-container { width:420px; height:620px; border:1px solid #ccc; border-radius:15px; background:#fff; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 0 15px rgba(0,0,0,0.2); }
#messages { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; }
.message { margin:8px 0; padding:10px 15px; border-radius:20px; max-width:75%; word-wrap:break-word; opacity:0; animation:fadeIn 0.3s forwards; }
@keyframes fadeIn {to {opacity:1;}}
.user { background:#4e9af1; color:white; align-self:flex-end; }
.bot { background:#e4e6eb; color:black; align-self:flex-start; }
#input-container { display:flex; border-top:1px solid #ccc; }
#input { flex:1; border:none; padding:12px; font-size:16px; }
#send { background:#4e9af1; color:white; border:none; padding:0 20px; cursor:pointer; font-weight:bold; }
#send:hover { background:#2d74c7; }
#buttons { display:flex; flex-wrap:wrap; gap:5px; justify-content:center; padding:10px; border-top:1px solid #ccc; background:#f9f9f9; }
#buttons button { padding:8px 12px; border:none; border-radius:12px; background:#4e9af1; color:white; cursor:pointer; font-size:14px; opacity:0; transition: opacity 0.5s ease-in-out; }
#buttons button.show { opacity:1; }
#buttons button:hover { background:#2d74c7; }
.user { background:#4e9af1; color:white; align-self:flex-end; }
.bot { background:#e4e6eb; color:black; align-self:flex-start; }
#input-container { display:flex; border-top:1px solid #ccc; }
#input { flex:1; border:none; padding:12px; font-size:16px; }
#send { background:#4e9af1; color:white; border:none; padding:0 20px; cursor:pointer; font-weight:bold; }
#send:hover { background:#2d74c7; }
#buttons { display:flex; flex-wrap:wrap; gap:5px; justify-content:center; padding:10px; border-top:1px solid #ccc; background:#f9f9f9; }
#buttons button { padding:8px 12px; border:none; border-radius:12px; background:#4e9af1; color:white; cursor:pointer; font-size:14px; opacity:0; transition: opacity 0.5s ease-in-out; }
#buttons button.show { opacity:1; }
#buttons button:hover { background:#2d74c7; }
</style>
</head>
<body>
<div id="chat-container">
  <div id="messages">
    <div class="message bot">ðŸ‘‹ Â¡Hola! Soy tu asistente de inducciÃ³n. Primero sigue el registro escribiendo tu *nombre completo*.</div>
  </div>

  <div id="buttons">
    <button onclick="preguntar('riesgos')">Riesgos y Peligros</button>
    <button onclick="preguntar('aspectos')">Aspectos Ambientales</button>
    <button onclick="preguntar('impacto')">Impacto Ambiental</button>
    <button onclick="preguntar('procedimientos')">Procedimientos Seguros</button>
    <button onclick="preguntar('comites')">ComitÃ©s</button>
    <button onclick="preguntar('emergencias')">Plan de Emergencias</button>
    <button onclick="preguntar('responsabilidades')">Funciones y Responsabilidades</button>
    <button onclick="enviarTema()">ðŸ“Œ Elegir Tema</button>
    <button onclick="enviarTema()">ðŸ“Œ Elegir Tema</button>
  </div>

  <div id="input-container">
    <input type="text" id="input" placeholder="Escribe tu respuesta aquÃ­..." />
    <button id="send">Enviar</button>
  </div>
</div>

<script>
const messages = document.getElementById("messages");
const input = document.getElementById("input");
const sendBtn = document.getElementById("send");
const buttons = document.getElementById("buttons");
const API_URL = "https://chatbot-idmv.onrender.com/chat"; // ajusta segÃºn deployment
const buttons = document.getElementById("buttons");
const API_URL = "https://chatbot-9v4j.onrender.com/chat"; // cambia segÃºn tu backend

const usuario_id = Math.random().toString(36).substr(2, 9);

// control de estado
let esperandoDocumento = false;  // controla si se estÃ¡ pidiendo documento
let documentoRegistrado = false;  // recuerda si ya se ingresÃ³
let temaSeleccionado = null;
let temaActual = null;

let temaSeleccionado = null;
let temaActual = null;
let esperandoDocumento = false;
let esperandoNombre = true;

// ðŸ”— Diccionario de equivalencias
const mapaTemas = {
  "riesgos": "1. Riesgos y Peligros",
  "aspectos": "2. Aspectos Ambientales",
  "impacto": "3. Impacto Ambiental",
  "procedimientos": "4. Procedimientos Seguros",
  "comites": "5. ComitÃ©s",
  "emergencias": "6. Plan de Emergencias",
  "responsabilidades": "7. Funciones y Responsabilidades"
};

function addMessage(text, sender) {
  if (!text) return;
  const div = document.createElement("div");
  div.classList.add("message", sender);
  div.textContent = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;

  // activar modo Documento solo si NO se ha registrado
  if (!documentoRegistrado && sender === "bot" && text.toLowerCase().includes("documento")) {
    esperandoDocumento = true;
  }

  // fin de registro
  if (sender === "bot" && text.toLowerCase().replace(/\s/g,'').includes("registrocompletado")) {
    esperandoDocumento = false;
    documentoRegistrado = true;
    mostrarBotonesTemas();
  }

  // fin de tema
  if (sender === "bot" && text.toLowerCase().includes("fin del tema")) {
    temaActual = null;
    mostrarBotonesTemas();
  }

  // activar modo Documento solo si NO se ha registrado
  if (!documentoRegistrado && sender === "bot" && text.toLowerCase().includes("documento")) {
    esperandoDocumento = true;
  }

  // fin de registro
  if (sender === "bot" && text.toLowerCase().replace(/\s/g,'').includes("registrocompletado")) {
    esperandoDocumento = false;
    documentoRegistrado = true;
    mostrarBotonesTemas();
  }

  // fin de tema
  if (sender === "bot" && text.toLowerCase().includes("fin del tema")) {
    temaActual = null;
    mostrarBotonesTemas();
  }
}

function renderTemas(lista) {
  lista.forEach(t => addMessage("ðŸ“Œ " + t, "bot"));
}

async function enviarPregunta(preguntaTexto) {
async function enviarPregunta(preguntaTexto) {
  const typingDiv = document.createElement("div");
  typingDiv.classList.add("message", "bot");
  typingDiv.textContent = "âœï¸ Escribiendo...";
  messages.appendChild(typingDiv);
  messages.scrollTop = messages.scrollHeight;

  try {
    const res = await fetch(API_URL, {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ pregunta: preguntaTexto, usuario_id })
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ pregunta: preguntaTexto, usuario_id })
    });
    const data = await res.json();
    const data = await res.json();
    messages.removeChild(typingDiv);
    manejarRespuesta(data);
  } catch (err) {
    manejarRespuesta(data);
  } catch (err) {
    typingDiv.textContent = "âŒ Error de conexiÃ³n con el servidor";
  }
}

function manejarRespuesta(data) {
  if (!data) return;

  if (data.respuesta) addMessage(data.respuesta, "bot");
  if (data.siguiente) addMessage(data.siguiente, "bot");
  if (data.confirm) addMessage(data.confirm, "bot");
  if (data.temas) renderTemas(data.temas);

  if (data.pregunta) addMessage(data.pregunta, "bot");
  if (data.opciones) {
    const opts = data.opciones.map(o => `â€¢ ${o}`).join("\n");
    addMessage("Opciones:\n" + opts, "bot");
  }

  if (data.temas) {
    mostrarBotonesTemas();
    temaActual = null;
    temaSeleccionado = null;
  }

  if (data.pregunta && temaSeleccionado) {
    temaActual = temaSeleccionado;
    temaSeleccionado = null;
    ocultarBotonesTemas();
  }

  if (data.respuesta && data.respuesta.toLowerCase().includes("has completado el tema")) {
    mostrarBotonesTemas();
    temaActual = null;
    temaSeleccionado = null;
  }
}

function enviarTema() {
  if (!documentoRegistrado) {
    addMessage("âš ï¸ Debes ingresar tu documento antes de elegir un tema.", "bot");
    return;
  }
  addMessage("ðŸ“Œ tema", "user");
  enviarPregunta("tema");
  temaSeleccionado = null;
}

function manejarRespuesta(data) {
  if (!data) return;

  if (data.respuesta) addMessage(data.respuesta, "bot");
  if (data.siguiente) addMessage(data.siguiente, "bot");
  if (data.confirm) addMessage(data.confirm, "bot");
  if (data.temas) renderTemas(data.temas);

  if (data.pregunta) addMessage(data.pregunta, "bot");
  if (data.opciones) {
    const opts = data.opciones.map(o => `â€¢ ${o}`).join("\n");
    addMessage("Opciones:\n" + opts, "bot");
  }

  if (data.temas) {
    mostrarBotonesTemas();
    temaActual = null;
    temaSeleccionado = null;
  }

  if (data.pregunta && temaSeleccionado) {
    temaActual = temaSeleccionado;
    temaSeleccionado = null;
    ocultarBotonesTemas();
  }

  if (data.respuesta && data.respuesta.toLowerCase().includes("has completado el tema")) {
    mostrarBotonesTemas();
    temaActual = null;
    temaSeleccionado = null;
  }
}

function enviarTema() {
  if (!documentoRegistrado) {
    addMessage("âš ï¸ Debes ingresar tu documento antes de elegir un tema.", "bot");
    return;
  }
  addMessage("ðŸ“Œ tema", "user");
  enviarPregunta("tema");
  temaSeleccionado = null;
}

sendBtn.addEventListener("click", () => {
  let q = input.value.trim();
  if (!q) return;

  // SOLO valida documento si NO se ha registrado
  if (!documentoRegistrado && esperandoDocumento) {
    if (!/^\d+$/.test(q)) {
      addMessage("âš ï¸ El documento solo puede contener nÃºmeros.", "bot");
      input.value = "";
      return;
    }
    esperandoDocumento = false;
    documentoRegistrado = true;
    mostrarBotonesTemas();
  }

  addMessage(q, "user");
  let q = input.value.trim();
  if (!q) return;

  // SOLO valida documento si NO se ha registrado
  if (!documentoRegistrado && esperandoDocumento) {
    if (!/^\d+$/.test(q)) {
      addMessage("âš ï¸ El documento solo puede contener nÃºmeros.", "bot");
      input.value = "";
      return;
    }
    esperandoDocumento = false;
    documentoRegistrado = true;
    mostrarBotonesTemas();
  }

  addMessage(q, "user");
  input.value = "";
  enviarPregunta(q);
  enviarPregunta(q);
});

input.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendBtn.click();
  if (!documentoRegistrado && esperandoDocumento && !/[0-9]/.test(e.key)) {
    e.preventDefault();
  }
});

input.addEventListener("paste", (e) => {
  if (!documentoRegistrado && esperandoDocumento) {
    const pasted = e.clipboardData.getData("text");
    if (!/^\d+$/.test(pasted)) e.preventDefault();
  }
  if (!documentoRegistrado && esperandoDocumento && !/[0-9]/.test(e.key)) {
    e.preventDefault();
  }
});

input.addEventListener("paste", (e) => {
  if (!documentoRegistrado && esperandoDocumento) {
    const pasted = e.clipboardData.getData("text");
    if (!/^\d+$/.test(pasted)) e.preventDefault();
  }
});

function preguntar(tema) {
  if (!documentoRegistrado) {
    addMessage("âš ï¸ Debes ingresar tu documento antes de elegir un tema.", "bot");
    return;
  }
  if (temaActual) {
    addMessage("âš ï¸ Debes terminar el tema actual antes de elegir otro.", "bot");
    return;
  }

  addMessage("ðŸ“Œ " + tema, "user");
  temaSeleccionado = tema;

  fetch(API_URL, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ pregunta: tema, usuario_id })
  })
  .then(r => r.json())
  .then(data => manejarRespuesta(data))
  .catch(() => addMessage("âŒ Error de conexiÃ³n con el servidor", "bot"));
}

function ocultarBotonesTemas() {
  const botones = buttons.querySelectorAll("button");
  botones.forEach(btn => {
    if (btn.textContent !== "ðŸ“Œ Elegir Tema") {
      btn.classList.remove("show");
      setTimeout(() => btn.style.display = "none", 300);
    }
  });
}

function mostrarBotonesTemas() {
  const botones = buttons.querySelectorAll("button");
  botones.forEach(btn => {
    btn.style.display = "inline-block";
    setTimeout(() => btn.classList.add("show"), 50);
  });
}

mostrarBotonesTemas();
  if (!documentoRegistrado) {
    addMessage("âš ï¸ Debes ingresar tu documento antes de elegir un tema.", "bot");
    return;
  }
  if (temaActual) {
    addMessage("âš ï¸ Debes terminar el tema actual antes de elegir otro.", "bot");
    return;
  }

  addMessage("ðŸ“Œ " + tema, "user");
  temaSeleccionado = tema;

  fetch(API_URL, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ pregunta: tema, usuario_id })
  })
  .then(r => r.json())
  .then(data => manejarRespuesta(data))
  .catch(() => addMessage("âŒ Error de conexiÃ³n con el servidor", "bot"));
}

function ocultarBotonesTemas() {
  const botones = buttons.querySelectorAll("button");
  botones.forEach(btn => {
    if (btn.textContent !== "ðŸ“Œ Elegir Tema") {
      btn.classList.remove("show");
      setTimeout(() => btn.style.display = "none", 300);
    }
  });
}

function mostrarBotonesTemas() {
  const botones = buttons.querySelectorAll("button");
  botones.forEach(btn => {
    btn.style.display = "inline-block";
    setTimeout(() => btn.classList.add("show"), 50);
  });
}

mostrarBotonesTemas();
</script>
</body>
</html>
