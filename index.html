<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chatbot Interactivo</title>
<style>
body { font-family: Arial, sans-serif; background:#f4f9f4; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
#chat-container { width:420px; height:620px; border:1px solid #ccc; border-radius:15px; background:#fff; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 0 15px rgba(0,0,0,0.2); }
#messages { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; }
.message { margin:8px 0; padding:10px 15px; border-radius:20px; max-width:75%; word-wrap:break-word; opacity:0; animation:fadeIn 0.3s forwards; }
@keyframes fadeIn {to {opacity:1;}}
.user { background:#4e9af1; color:white; align-self:flex-end; }
.bot { background:#e4e6eb; color:black; align-self:flex-start; white-space:pre-line; }
#input-container { display:flex; border-top:1px solid #ccc; }
#input { flex:1; border:none; padding:12px; font-size:16px; }
#send { background:#4e9af1; color:white; border:none; padding:0 20px; cursor:pointer; font-weight:bold; }
#send:hover { background:#2d74c7; }
#buttons { display:flex; flex-wrap:wrap; gap:5px; justify-content:center; padding:10px; border-top:1px solid #ccc; background:#f9f9f9; }
#buttons button { padding:8px 12px; border:none; border-radius:12px; background:#4e9af1; color:white; cursor:pointer; font-size:14px; opacity:0; transition: opacity 0.5s ease-in-out; position:relative; }
#buttons button.show { opacity:1; }
#buttons button:hover { background:#2d74c7; }

/* ‚úÖ estilo para botones completados */
#buttons button.completed {
  background: #ccc !important;
  color: #666 !important;
  cursor: not-allowed !important;
}
#buttons button.completed::after {
  content: "‚úîÔ∏è";
  position: absolute;
  right: 8px;
  font-size: 16px;
}
</style>
</head>
<body>
<div id="chat-container">
  <div id="messages"></div>

  <div id="buttons">
    <button onclick="preguntar('riesgos')">1. Riesgos y Peligros</button>
    <button onclick="preguntar('aspectos')">2. Aspectos Ambientales</button>
    <button onclick="preguntar('impacto')">3. Impacto Ambiental</button>
    <button onclick="preguntar('procedimientos')">4. Procedimientos Seguros</button>
    <button onclick="preguntar('comites')">5. Comit√©s</button>
    <button onclick="preguntar('emergencias')">6. Plan de Emergencias</button>
    <button onclick="preguntar('responsabilidades')">7. Funciones y Responsabilidades</button>
    <button onclick="enviarTema()">üìå Elegir Tema</button>
  </div>

  <div id="input-container">
    <input type="text" id="input" placeholder="Escribe tu respuesta aqu√≠..." />
    <button id="send">Enviar</button>
  </div>
</div>

<script>
const messages = document.getElementById("messages");
const input = document.getElementById("input");
const sendBtn = document.getElementById("send");
const buttons = document.getElementById("buttons");
const API_URL = "https://chatbot-9v4j.onrender.com/chat"; // cambia seg√∫n tu backend

const usuario_id = Math.random().toString(36).substr(2, 9);

let temaSeleccionado = null;
let temaActual = null;
let esperandoDocumento = false;
let esperandoNombre = true;

// üîó Diccionario de equivalencias
const mapaTemas = {
  "riesgos": "1. Riesgos y Peligros",
  "aspectos": "2. Aspectos Ambientales",
  "impacto": "3. Impacto Ambiental",
  "procedimientos": "4. Procedimientos Seguros",
  "comites": "5. Comit√©s",
  "emergencias": "6. Plan de Emergencias",
  "responsabilidades": "7. Funciones y Responsabilidades"
};

function addMessage(text, sender) {
  if (!text) return;
  const div = document.createElement("div");
  div.classList.add("message", sender);
  div.innerHTML = text.replace(/\n/g, "<br>");
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;

  if (sender === "bot" && text.toLowerCase().includes("documento")) {
    esperandoDocumento = true;
    esperandoNombre = false;
  }

  if (sender === "bot" && text.toLowerCase().replace(/\s/g,'').includes("registrocompletado")) {
    esperandoDocumento = false;
    esperandoNombre = false;
    temaActual = null;
    mostrarBotonesTemas();
  }

  if (sender === "bot" && text.toLowerCase().includes("fin del tema")) {
    marcarTemaCompletado(temaActual);
    temaActual = null;
    mostrarBotonesTemas();
  }
}

async function enviarPregunta(preguntaTexto) {
  const typingDiv = document.createElement("div");
  typingDiv.classList.add("message", "bot");
  typingDiv.textContent = "‚úçÔ∏è Escribiendo...";
  messages.appendChild(typingDiv);
  messages.scrollTop = messages.scrollHeight;

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ pregunta: preguntaTexto, usuario_id })
    });
    const data = await res.json();
    messages.removeChild(typingDiv);
    manejarRespuesta(data);
  } catch (err) {
    typingDiv.textContent = "‚ùå Error de conexi√≥n con el servidor";
  }
}

function manejarRespuesta(data) {
  if (!data) return;

  if (data.respuesta) addMessage(data.respuesta, "bot");
  if (data.siguiente) addMessage(data.siguiente, "bot");
  if (data.confirm) addMessage(data.confirm, "bot");
  if (data.temas) renderTemas(data.temas);
  if (data.pregunta) addMessage(data.pregunta, "bot");

  if (data.opciones) {
    const opts = data.opciones.map(o => `‚Ä¢ ${o}`).join("<br>");
    addMessage("Opciones:<br>" + opts, "bot");
  }

  if (data.temas) {
    mostrarBotonesTemas();
    temaActual = null;
    temaSeleccionado = null;
  }

  if (data.pregunta && temaSeleccionado) {
    temaActual = temaSeleccionado;
    temaSeleccionado = null;
    ocultarBotonesTemas();
  }

  if (data.respuesta && (
      data.respuesta.toLowerCase().includes("has completado el tema") ||
      data.respuesta.toLowerCase().includes("fin del tema")
    )) {
    marcarTemaCompletado(temaActual);
    temaActual = null;
    temaSeleccionado = null;
    mostrarBotonesTemas();
  }

  if (!esperandoDocumento && !esperandoNombre) {
    mostrarBotonesTemas();
  }
}

function marcarTemaCompletado(tema) {
  if (!tema) return;
  const nombreBoton = mapaTemas[tema];
  if (!nombreBoton) return;

  const btns = buttons.querySelectorAll("button");
  btns.forEach(btn => {
    if (btn.textContent.trim() === nombreBoton) {
      btn.classList.add("completed");
      btn.disabled = true;
    }
  });
}

function renderTemas(lista) {
  lista.forEach(t => addMessage("üìå " + t, "bot"));
}

function enviarTema() {
  if (esperandoNombre) {
    addMessage("‚ö†Ô∏è Debes ingresar tu nombre antes de elegir un tema.", "bot");
    return;
  }
  if (esperandoDocumento) {
    addMessage("‚ö†Ô∏è Debes ingresar tu documento antes de elegir un tema.", "bot");
    return;
  }
  addMessage("üìå tema", "user");
  enviarPregunta("tema");
  temaSeleccionado = null;
}

sendBtn.addEventListener("click", () => {
  let q = input.value.trim();
  if (!q) return;

  if (esperandoNombre) {
    if (!/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/.test(q)) {
      addMessage("‚ö†Ô∏è El nombre solo puede contener letras y espacios.", "bot");
      input.value = "";
      return;
    }
    esperandoNombre = false;
  }

  if (esperandoDocumento) {
    if (!/^\d+$/.test(q)) {
      addMessage("‚ö†Ô∏è El documento solo puede contener n√∫meros.", "bot");
      input.value = "";
      return;
    }
    esperandoDocumento = false;
    mostrarBotonesTemas();
  }

  addMessage(q, "user");
  input.value = "";
  enviarPregunta(q);
});

input.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendBtn.click();
  if (esperandoDocumento && !/[0-9]/.test(e.key)) e.preventDefault();
  if (esperandoNombre && !/[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]/.test(e.key)) e.preventDefault();
});

input.addEventListener("paste", (e) => {
  const pasted = e.clipboardData.getData("text");
  if (esperandoDocumento && !/^\d+$/.test(pasted)) e.preventDefault();
  if (esperandoNombre && !/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/.test(pasted)) e.preventDefault();
});

function preguntar(tema) {
  if (esperandoNombre) {
    addMessage("‚ö†Ô∏è Debes ingresar tu nombre antes de elegir un tema.", "bot");
    return;
  }
  if (esperandoDocumento) {
    addMessage("‚ö†Ô∏è Debes ingresar tu documento antes de elegir un tema.", "bot");
    return;
  }
  if (temaActual) {
    addMessage("‚ö†Ô∏è Debes terminar el tema actual antes de elegir otro.", "bot");
    return;
  }

  addMessage("üìå " + tema, "user");
  temaSeleccionado = tema;

  fetch(API_URL, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ pregunta: tema, usuario_id })
  })
  .then(r => r.json())
  .then(data => manejarRespuesta(data))
  .catch(() => addMessage("‚ùå Error de conexi√≥n con el servidor", "bot"));
}

function ocultarBotonesTemas() {
  const botones = buttons.querySelectorAll("button");
  botones.forEach(btn => {
    if (btn.textContent !== "üìå Elegir Tema") {
      btn.classList.remove("show");
      setTimeout(() => btn.style.display = "none", 300);
    }
  });
}

function mostrarBotonesTemas() {
  const botones = buttons.querySelectorAll("button");
  botones.forEach(btn => {
    btn.style.display = "inline-block";
    setTimeout(() => btn.classList.add("show"), 50);
  });
}

mostrarBotonesTemas();

// üöÄ mensaje inicial
window.addEventListener("DOMContentLoaded", () => {
  enviarPregunta("");
});
</script>
</body>
</html>
